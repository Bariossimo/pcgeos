/*-------------------------------------------------------------------
include files
-------------------------------------------------------------------*/
@include <stdapp.goh>
@include <Objects/eMenuC.goh>
@include <Objects/gFieldC.goh>
@include <iacp.goh>

#include <token.h>
#include <object.h>

/*-------------------------------------------------------------------
globals & constants
-------------------------------------------------------------------*/
optr        G_wrapper               = NullOptr;
dword       G_trayAppsFolderID      = 0;
word        G_trayAppsFilesCount    = 0;

#define MAX_TRAY_TRIGGERS_COUNT 25

/*-------------------------------------------------------------------
class & message definitions
-------------------------------------------------------------------*/
@class  TrayAppsProcessClass, GenProcessClass;

    @message void MSG_ADD_WRAPPER();
    @message word MSG_READ_APPS_IN_FOLDER(MemHandle *trayFilesHan);
    @message word MSG_COUNT_APPS_IN_FOLDER();
@endc   /* end of class definition */


@class  TrayAppsApplicationClass, GenApplicationClass;

    @message void MSG_EMC_WRAPPER_CREATED(CreateExpressMenuControlItemResponseParams *response = ss:bp);
    @message void MSG_INIT_APP_TRIGGERS();
    @message (GEN_TRIGGER_ACTION) MSG_APP_TRIGGER_PRESSED;
    @message void MSG_REMOVE_ALL_APP_TRIGGERS();
    @message void MSG_REMOVE_WRAPPER();
@endc   /* end of class definition */


@class GenGeodeTokenTriggerClass, GenTriggerClass;
    @vardata GeodeToken ATTR_GEODE_TOKEN_TO_PASS;
@endc;

@classdecl   TrayAppsProcessClass, neverSaved;
@classdecl   TrayAppsApplicationClass;
@classdecl   GenGeodeTokenTriggerClass, neverSaved;

/*-------------------------------------------------------------------
UI Objects
-------------------------------------------------------------------*/
@start  AppResource;

    @object TrayAppsApplicationClass TrayAppsApp =
    {
        GAI_states = (((@default) | (AS_NOT_USER_INTERACTABLE) | (AS_AVOID_TRANSPARENT_DETACH)) & ((~AS_FOCUSABLE) & (~AS_MODELABLE)));
        GI_attrs = ((@default) & (~GA_TARGETABLE));

        GI_visMoniker = list {@TrayAppsAppTextMoniker};
    }

    @visMoniker TrayAppsAppTextMoniker = "TrayApps";

@end    AppResource;

@start  Templates;

    @object GenGeodeTokenTriggerClass TriggerTemplate =
    {
        GI_states = @default & ~GS_USABLE;
        GI_visMoniker = "T";
    }

@end    Templates;

/*-------------------------------------------------------------------
we're born!
-------------------------------------------------------------------*/
@method TrayAppsProcessClass, MSG_GEN_PROCESS_OPEN_APPLICATION
{
    MemHandle   trayAppsFolderIDBlock   = 0;
    ChunkHandle trayAppsFolderIDChunk   = 0;
    FilePathID  *idArr                  = 0;
    //dword       no = 0;

    @callsuper();

    //if (FileSetCurrentPath(SP_USER_DATA, "TRAYAPPS"))
    if (FileSetCurrentPath(SP_APPLICATION, "TRAYAPPS"))
    {
        trayAppsFolderIDBlock = MemAllocLMem(LMEM_TYPE_GENERAL, 0);
        trayAppsFolderIDChunk = FileGetCurrentPathIDs(trayAppsFolderIDBlock);
        (void) MemLock(trayAppsFolderIDBlock);
        idArr = (FilePathID*) LMemDerefHandles(trayAppsFolderIDBlock, trayAppsFolderIDChunk);
        //no = LMemGetChunkSizeHandles(trayAppsFolderIDBlock, trayAppsFolderIDChunk) / sizeof(FilePathID);
        G_trayAppsFolderID = idArr->FPID_id;
        MemUnlock(trayAppsFolderIDBlock);

        @call process::MSG_ADD_WRAPPER();

        (void) GCNListAdd(
            ConstructOptr(GeodeGetProcessHandle(), 0),  // optr to add to list
            MANUFACTURER_ID_GEOWORKS,                   // manufacturer ID of list
            GCNSLT_FILE_SYSTEM
        );
    }
}

/*-------------------------------------------------------------------
let's see if someone put something in/out of our folder
-------------------------------------------------------------------*/
@method TrayAppsProcessClass, MSG_NOTIFY_FILE_CHANGE
{
    FileChangeBatchNotificationData *notificationData;
    FileChangeBatchNotificationItem *notificationItem = 0;
    word                            numFiles = 0;

    if (notifyType == FCNT_BATCH)
    {
        notificationData = (FileChangeBatchNotificationData*) MemLock(data);
        notificationItem = &notificationData->FCBND_notifications[0];

        while(((word) notificationItem) < notificationData->FCBND_end)
        {
            word itemSize;

            if ((notificationItem->FCBNI_type == FCNT_CREATE) &&
                (G_trayAppsFolderID == notificationItem->FCBNI_id))
            {
                G_trayAppsFilesCount = @call process::MSG_COUNT_APPS_IN_FOLDER();
                @call process::MSG_INIT_APP_TRIGGERS();
                break;
            }

            if (notificationItem->FCBNI_type == FCNT_DELETE)
            {
                numFiles = @call process::MSG_COUNT_APPS_IN_FOLDER();
                if (numFiles < G_trayAppsFilesCount)
                {
                    G_trayAppsFilesCount = numFiles;
                    @call process::MSG_INIT_APP_TRIGGERS();
                    break;
                }
            }

            if (
                 (notificationItem->FCBNI_type == FCNT_CREATE) ||
                 (notificationItem->FCBNI_type == FCNT_RENAME)
               )
            {
                /* skip large item for next */
                itemSize = sizeof(FileChangeBatchNotificationItem);
            }
            else
            {
                /* skip small item for next */
                itemSize = sizeof(offsetof(FileChangeBatchNotificationItem, FCBNI_name));
            }

            notificationItem = (FileChangeBatchNotificationItem*) (((byte*) notificationItem) + itemSize);
        }

        MemUnlock(data);
    }

    @callsuper();
}

/*-------------------------------------------------------------------
add GenInteraction as "Spacer"
-------------------------------------------------------------------*/
@method TrayAppsProcessClass, MSG_ADD_WRAPPER
{
    CreateExpressMenuControlItemParams  cemcip;
    EventHandle                         event;

    cemcip.CEMCIP_feature = CEMCIF_SYSTEM_TRAY;
    cemcip.CEMCIP_class = &GenInteractionClass;
    cemcip.CEMCIP_itemPriority = CEMCIP_STANDARD_PRIORITY;
    cemcip.CEMCIP_responseMessage = MSG_EMC_WRAPPER_CREATED;
    cemcip.CEMCIP_responseDestination = GeodeGetAppObject(0); // ConstructOptr(GeodeGetProcessHandle(), 0);
    cemcip.CEMCIP_field = NullOptr;

    event = @record ExpressMenuControlClass::MSG_EXPRESS_MENU_CONTROL_CREATE_ITEM(cemcip);
    GCNListSend(MANUFACTURER_ID_GEOWORKS, GCNSLT_EXPRESS_MENU_OBJECTS, event, 0, 0);
}

/*-------------------------------------------------------------------
initializes the newly created Express menu trigger
-------------------------------------------------------------------*/
@method TrayAppsApplicationClass, MSG_EMC_WRAPPER_CREATED
{
    Rectangle   margins = {3, 0, 0, 0};

    G_wrapper = response->CEMCIRP_newItem;

    @call G_wrapper::MSG_META_ADD_VAR_DATA(
        (HINT_CUSTOM_EXTRA_MARGINS & (~VDF_SAVE_TO_STATE)),
        sizeof(Rectangle),
        &margins
    );

    @call G_wrapper::MSG_META_ADD_VAR_DATA(
        (HINT_ORIENT_CHILDREN_HORIZONTALLY & (~VDF_SAVE_TO_STATE)),
        0,
        (void*) 0
    );

    @call G_wrapper::MSG_META_ADD_VAR_DATA(
        (HINT_CUSTOM_CHILD_SPACING & (~VDF_SAVE_TO_STATE)),
        sizeof(word),
        (void*) 0
    );

    @call G_wrapper::MSG_GEN_SET_USABLE(VUM_NOW);

    @call oself::MSG_INIT_APP_TRIGGERS();

    //@callsuper();
}

/*-------------------------------------------------------------------
add / remove / re-add launchers
-------------------------------------------------------------------*/
@method TrayAppsApplicationClass, MSG_INIT_APP_TRIGGERS
{
    optr                triggerObj = NullOptr;
    ThreadHandle        thread = NullHandle;
    Boolean             isGMoniker = FALSE;
    MemHandle           newMoniker = NULL;
    word                monikerSize = 0;
    GeodeToken          tok;
    char*               filePtr = (void*) 0;
    byte                triggerNo = 0;
    MemHandle           trayFilesHan = NullHandle;

    thread = MemGetInfo(OptrToHandle(G_wrapper), MGIT_EXEC_THREAD);

    @call oself::MSG_REMOVE_ALL_APP_TRIGGERS();

    G_trayAppsFilesCount = @call process::MSG_READ_APPS_IN_FOLDER(&trayFilesHan);
    if (G_trayAppsFilesCount > 0)
    {
        for (triggerNo=0; triggerNo < G_trayAppsFilesCount; triggerNo++)
        {
            if (triggerNo >= MAX_TRAY_TRIGGERS_COUNT) break;

            filePtr = MemLock(trayFilesHan);
            filePtr = filePtr + (triggerNo * FILE_LONGNAME_BUFFER_SIZE);
            FileGetPathExtAttributes(filePtr, FEA_TOKEN, (&tok), sizeof(GeodeToken));
            MemUnlock(trayFilesHan);

            triggerObj = ConstructOptr(
                ObjDuplicateResource(
                    OptrToHandle(@TriggerTemplate), 0, thread
                ),
                OptrToChunk(@TriggerTemplate)
            );

            @send G_wrapper::MSG_GEN_ADD_CHILD(triggerObj, CCO_LAST);

            isGMoniker = TokenLoadMonikerBlock(
                TOKEN_CHARS(tok.GT_chars[0],tok.GT_chars[1],tok.GT_chars[2],tok.GT_chars[3]),
                tok.GT_manufID,
                (DT_DISP_SIZE | DT_DISP_ASPECT_RATIO | DT_DISP_CLASS),
                ((VMSF_GSTRING) | (VMS_TOOL << VMSF_STYLE_OFFSET)),
                &monikerSize,
                &newMoniker
            );

            if (isGMoniker)
            {
                @call triggerObj::MSG_GEN_REPLACE_VIS_MONIKER(
                    VUM_NOW,
                    0, 0, monikerSize,
                    VMDT_VIS_MONIKER,
                    VMST_HPTR,
                    (dword)(ConstructOptr(newMoniker, 0))
                );

                @call triggerObj::MSG_GEN_TRIGGER_SET_ACTION_MSG(MSG_APP_TRIGGER_PRESSED);
                @call triggerObj::MSG_GEN_TRIGGER_SET_DESTINATION(oself);
                //@call obj::MSG_META_ADD_VAR_DATA(HINT_NO_BORDERS_ON_MONIKERS, 0, (void*) 0);
                @call triggerObj::MSG_META_ADD_VAR_DATA((ATTR_GEODE_TOKEN_TO_PASS & (~VDF_SAVE_TO_STATE)), sizeof(GeodeToken), &tok);
                @call triggerObj::MSG_GEN_SET_USABLE(VUM_NOW);

                MemFree(newMoniker);
            }

            @call triggerObj::MSG_GEN_SET_USABLE(VUM_NOW);
        }
    }
}

/*-------------------------------------------------------------------
one of our triggers has been pressed, launch app
-------------------------------------------------------------------*/
@method TrayAppsApplicationClass, MSG_APP_TRIGGER_PRESSED
{
    GeodeToken           gt;
    IACPConnection       iacpConnectionToken = IACP_NO_CONNECTION;
    word                 connectionFlags = IACPSM_USER_INTERACTIBLE;
    word                 serverCount;
    MemHandle            hLaunchBlock;

    @call trigger::MSG_META_GET_VAR_DATA(ATTR_GEODE_TOKEN_TO_PASS, sizeof(GeodeToken), &gt);

    hLaunchBlock = IACPCreateDefaultLaunchBlock(MSG_GEN_PROCESS_OPEN_APPLICATION);
    iacpConnectionToken = IACPConnect(
        &gt,
        connectionFlags,
        hLaunchBlock,
        NullOptr,
        &serverCount
    );

    if(iacpConnectionToken != IACP_NO_CONNECTION)
    {
        IACPShutdown(iacpConnectionToken, NullOptr);
    }
}

/*-------------------------------------------------------------------
prepare our demise
-------------------------------------------------------------------*/
@method TrayAppsApplicationClass, MSG_META_DETACH
{
    // remove triggers
    @call oself::MSG_REMOVE_ALL_APP_TRIGGERS();

    // remove wrapper
    @call oself::MSG_REMOVE_WRAPPER();

    @callsuper();
}


/*-------------------------------------------------------------------
prepare our demise
-------------------------------------------------------------------*/
@method TrayAppsProcessClass, MSG_GEN_PROCESS_CLOSE_APPLICATION
{
    // take us off of notification list
    (void) GCNListRemove(
        ConstructOptr(GeodeGetProcessHandle(), 0),  // optr of thread to remove from list
        MANUFACTURER_ID_GEOWORKS,                   // manufacturer ID of list
        GCNSLT_FILE_SYSTEM
    );

    return(@callsuper());
}


/*-------------------------------------------------------------------
remove spacer
-------------------------------------------------------------------*/
@method TrayAppsApplicationClass, MSG_REMOVE_WRAPPER
{
    EventHandle    event;

    if (G_wrapper != NullOptr)
    {
        event = @record ExpressMenuControlClass::MSG_EXPRESS_MENU_CONTROL_DESTROY_CREATED_ITEM(G_wrapper, VUM_NOW);
        GCNListSend(MANUFACTURER_ID_GEOWORKS, GCNSLT_EXPRESS_MENU_OBJECTS, event, 0, 0);
    }
}


/*-------------------------------------------------------------------
remove all our triggers from SysTray
-------------------------------------------------------------------*/
@method TrayAppsApplicationClass, MSG_REMOVE_ALL_APP_TRIGGERS
{
    optr    trigger = NullOptr;

    while(TRUE)
    {
        trigger = @call G_wrapper::MSG_GEN_FIND_CHILD_AT_POSITION(0);
        if (trigger == NullOptr) break;
        @call trigger::MSG_GEN_SET_NOT_USABLE(VUM_NOW);
        @call G_wrapper::MSG_GEN_REMOVE_CHILD(trigger, CCF_MARK_DIRTY);
        @call trigger::MSG_META_OBJ_FREE();
        trigger = NullOptr;
    }
}

/*-------------------------------------------------------------------
read apps in folder into passed variable: MemHandle *trayFilesHan
numOfFiles returned
-------------------------------------------------------------------*/
@method TrayAppsProcessClass, MSG_READ_APPS_IN_FOLDER
{
    FileEnumParams       fileEnumParams;
    word                 filesNotHandled = NULL;
    word                 numOfFiles = NULL;

    fileEnumParams.FEP_searchFlags = FESF_GEOS_EXECS;
    fileEnumParams.FEP_returnAttrs = (void*) FESRT_NAME;  /* Return the file's Geos filename.*/
    fileEnumParams.FEP_returnSize = FILE_LONGNAME_BUFFER_SIZE;
    fileEnumParams.FEP_bufSize = FE_BUFSIZE_UNLIMITED;    /* FE_BUFSIZE_UNLIMITED allows the return buffer size to be as large as necessary.*/
    fileEnumParams.FEP_matchAttrs = 0;  /* Set matchAttrs to zero so it will match anything.*/
    fileEnumParams.FEP_skipCount = 0;   /* Don't skip any files*/
    fileEnumParams.FEP_callback = 0;   /* Don't need no callback. */

    if (*trayFilesHan != NullHandle)
    {
        MemFree(*trayFilesHan);
    }

    numOfFiles = FileEnum(
        &fileEnumParams,
        trayFilesHan,
        &filesNotHandled
    );

    return(numOfFiles);
}

/*-------------------------------------------------------------------
count apps in folder
numOfFiles returned
-------------------------------------------------------------------*/
@method TrayAppsProcessClass, MSG_COUNT_APPS_IN_FOLDER
{
    FileEnumParams       fileEnumParams;
    word                 numOfFiles = NULL;

    fileEnumParams.FEP_searchFlags = FESF_GEOS_EXECS;
    fileEnumParams.FEP_returnAttrs = (void*) FESRT_COUNT_ONLY;  /*Return the file's Geos filename.*/
    fileEnumParams.FEP_returnSize = 0;
    fileEnumParams.FEP_bufSize = FE_BUFSIZE_UNLIMITED;    /* FE_BUFSIZE_UNLIMITED allows the return buffer size to be as large as necessary.*/
    fileEnumParams.FEP_matchAttrs = 0;  /* Set matchAttrs to zero so it will match anything.*/
    fileEnumParams.FEP_skipCount = 0;   /* Don't skip any files*/
    fileEnumParams.FEP_callback = 0;   /* Don't need no callback. */

    (void) FileEnum(&fileEnumParams, NullHandle, &numOfFiles);
    return numOfFiles;
}


/*------------------------------------------------------------------
This is called by MSG_META_DETACH and allows for changing the
name of the state file which should be created for the application.
We don't want no state file, so we just return 0.
------------------------------------------------------------------*/
@method TrayAppsProcessClass, MSG_GEN_PROCESS_CREATE_NEW_STATE_FILE
{
    return 0;
}

void ShowStopper()
{
    // Dummy for Swatting
    return;
}
